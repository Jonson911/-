<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¦è™‘ç¼“è§£æ•ˆèƒ½è¿½è¸ªå™¨</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body { font-family: 'Microsoft YaHei', sans-serif; background-color: #f0f9ff; }
        .card { background: white; border-radius: 12px; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
    </style>
</head>
<body class="text-gray-700 p-4 md:p-8">

    <div class="max-w-3xl mx-auto">
        
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-blue-600 mb-2">ğŸŒŸ ç„¦è™‘ç¼“è§£æ•ˆèƒ½è¿½è¸ª</h1>
            <p class="text-sm text-gray-500">è®°å½•å½“ä¸‹ï¼Œçœ‹è§æ”¹å˜</p>
        </header>

        <div class="card p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 border-l-4 border-blue-500 pl-3">ğŸ“ æ–°çš„è®°å½•</h2>
            
            <form id="trackerForm" class="space-y-4">
                <div>
                    <label class="block text-sm font-medium mb-1">å½“å‰ç„¦è™‘ç¨‹åº¦ (1-10)</label>
                    <input type="range" id="anxietyLevel" min="1" max="10" value="5" class="w-full h-2 bg-gray-200 rounded-lg appearance-none cursor-pointer accent-blue-600" oninput="document.getElementById('levelVal').innerText = this.value">
                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>ğŸ˜Œ å¹³é™(1)</span>
                        <span class="text-blue-600 font-bold text-lg" id="levelVal">5</span>
                        <span>ğŸ¤¯ æåº¦(10)</span>
                    </div>
                </div>

                <div class="grid grid-cols-2 gap-4">
                    <div>
                        <label class="block text-sm font-medium mb-1">é«˜å‹ (æ”¶ç¼©å‹)</label>
                        <input type="number" id="sysBP" placeholder="ä¾‹å¦‚: 120" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none">
                    </div>
                    <div>
                        <label class="block text-sm font-medium mb-1">ä½å‹ (èˆ’å¼ å‹)</label>
                        <input type="number" id="diaBP" placeholder="ä¾‹å¦‚: 80" class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none">
                    </div>
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">å¦‚æœä½ åšäº†ä»€ä¹ˆæ¥ç¼“è§£ (å¯é€‰)</label>
                    <input type="text" id="activity" placeholder="ä¾‹å¦‚ï¼šæ·±å‘¼å¸ã€æ•£æ­¥ã€å†¥æƒ³ã€åƒè¯..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none">
                </div>

                <div>
                    <label class="block text-sm font-medium mb-1">å¤‡æ³¨/æ„Ÿå—</label>
                    <textarea id="note" rows="2" placeholder="ç®€å•è®°å½•å½“ä¸‹çš„æƒ³æ³•..." class="w-full p-2 border rounded focus:ring-2 focus:ring-blue-300 outline-none"></textarea>
                </div>

                <button type="submit" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 transition font-bold shadow-md">
                    ä¿å­˜è®°å½•
                </button>
            </form>
        </div>

        <div class="card p-6 mb-8">
            <h2 class="text-xl font-semibold mb-4 border-l-4 border-purple-500 pl-3">ğŸ“Š è¶‹åŠ¿åˆ†æ</h2>
            <canvas id="trendChart" height="200"></canvas>
        </div>

        <div class="card p-6">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-semibold border-l-4 border-green-500 pl-3">ğŸ—‚ï¸ å†å²è®°å½•</h2>
                <button onclick="clearData()" class="text-xs text-red-400 hover:text-red-600 underline">æ¸…ç©ºæ•°æ®</button>
            </div>
            <div class="overflow-x-auto">
                <table class="min-w-full text-sm text-left text-gray-500">
                    <thead class="text-xs text-gray-700 uppercase bg-gray-50">
                        <tr>
                            <th class="px-4 py-3">æ—¶é—´</th>
                            <th class="px-4 py-3">ç„¦è™‘å€¼</th>
                            <th class="px-4 py-3">è¡€å‹</th>
                            <th class="px-4 py-3">è¡ŒåŠ¨/å¤‡æ³¨</th>
                        </tr>
                    </thead>
                    <tbody id="historyList">
                        </tbody>
                </table>
            </div>
        </div>

    </div>

    <script>
        // åˆå§‹åŒ–æ•°æ®
        let records = JSON.parse(localStorage.getItem('anxiety_records')) || [];
        const form = document.getElementById('trackerForm');
        const historyList = document.getElementById('historyList');
        let chartInstance = null;

        // æ¸²æŸ“é¡µé¢
        function render() {
            // 1. æ¸²æŸ“åˆ—è¡¨
            historyList.innerHTML = '';
            // æŒ‰æ—¶é—´å€’åºæ’åˆ—
            const sortedRecords = [...records].reverse(); 
            
            sortedRecords.forEach(record => {
                const row = document.createElement('tr');
                row.className = "border-b hover:bg-gray-50";
                const date = new Date(record.timestamp).toLocaleString('zh-CN', { month: 'numeric', day: 'numeric', hour: '2-digit', minute: '2-digit' });
                
                // ç„¦è™‘å€¼çš„é¢œè‰²æ ‡è®°
                let anxietyColor = record.anxiety >= 8 ? 'text-red-600 font-bold' : (record.anxiety <= 3 ? 'text-green-600' : 'text-yellow-600');
                
                row.innerHTML = `
                    <td class="px-4 py-3">${date}</td>
                    <td class="px-4 py-3 ${anxietyColor}">${record.anxiety}</td>
                    <td class="px-4 py-3">${record.sysBP || '-'} / ${record.diaBP || '-'}</td>
                    <td class="px-4 py-3">
                        <div class="font-medium text-gray-800">${record.activity || '-'}</div>
                        <div class="text-xs text-gray-400">${record.note || ''}</div>
                    </td>
                `;
                historyList.appendChild(row);
            });

            // 2. æ¸²æŸ“å›¾è¡¨
            updateChart();
        }

        function updateChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            // åªå–æœ€è¿‘10æ¡æ•°æ®æ–¹ä¾¿å±•ç¤º
            const recentRecords = records.slice(-15); 
            
            const labels = recentRecords.map(r => new Date(r.timestamp).toLocaleTimeString('zh-CN', {hour: '2-digit', minute:'2-digit'}));
            const anxietyData = recentRecords.map(r => r.anxiety);
            const sysBPData = recentRecords.map(r => r.sysBP);

            if (chartInstance) {
                chartInstance.destroy();
            }

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'ç„¦è™‘ç¨‹åº¦',
                            data: anxietyData,
                            borderColor: 'rgb(37, 99, 235)', // Blue
                            backgroundColor: 'rgba(37, 99, 235, 0.1)',
                            borderWidth: 2,
                            tension: 0.3,
                            yAxisID: 'y'
                        },
                        {
                            label: 'é«˜å‹(æ”¶ç¼©å‹)',
                            data: sysBPData,
                            borderColor: 'rgb(220, 38, 38)', // Red
                            borderWidth: 1,
                            borderDash: [5, 5],
                            pointRadius: 2,
                            yAxisID: 'y1',
                            hidden: false
                        }
                    ]
                },
                options: {
                    responsive: true,
                    interaction: { mode: 'index', intersect: false },
                    scales: {
                        y: {
                            type: 'linear',
                            display: true,
                            position: 'left',
                            min: 0,
                            max: 10,
                            title: { display: true, text: 'ç„¦è™‘æŒ‡æ•°' }
                        },
                        y1: {
                            type: 'linear',
                            display: true,
                            position: 'right',
                            min: 60,
                            max: 200,
                            grid: { drawOnChartArea: false }, // ä¸ç”»ç½‘æ ¼çº¿ï¼Œä¿æŒå¹²å‡€
                            title: { display: true, text: 'è¡€å‹(mmHg)' }
                        }
                    }
                }
            });
        }

        // è¡¨å•æäº¤å¤„ç†
        form.addEventListener('submit', (e) => {
            e.preventDefault();
            
            const newRecord = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                anxiety: parseInt(document.getElementById('anxietyLevel').value),
                sysBP: document.getElementById('sysBP').value,
                diaBP: document.getElementById('diaBP').value,
                activity: document.getElementById('activity').value,
                note: document.getElementById('note').value
            };

            records.push(newRecord);
            localStorage.setItem('anxiety_records', JSON.stringify(records));
            
            form.reset();
            // é‡ç½®æ»‘å—æ˜¾ç¤º
            document.getElementById('levelVal').innerText = '5';
            document.getElementById('anxietyLevel').value = 5;
            
            render();
        });

        function clearData() {
            if(confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰è®°å½•å—ï¼Ÿæ­¤æ“ä½œä¸å¯æ¢å¤ã€‚')) {
                records = [];
                localStorage.removeItem('anxiety_records');
                render();
            }
        }

        // å¯åŠ¨
        render();
    </script>
</body>
</html>