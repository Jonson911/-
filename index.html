<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç„¦è™‘ç¼“è§£æ•ˆèƒ½è¿½è¸ªå™¨ v2.0</title>
    
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- å¼•å…¥ Phosphor Icons (ç”¨äºå›¾æ ‡) -->
    <script src="https://unpkg.com/@phosphor-icons/web"></script>

    <!-- PWA é…ç½®å…³è” (ä¸ºå°†æ¥çš„ App å°è£…åšå‡†å¤‡) -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ffffff">
    <!-- ä½¿ç”¨ä¸€ä¸ªé€šç”¨çš„å›¾æ ‡ä½œä¸º apple-touch-icon ç¤ºä¾‹ -->
    <link rel="apple-touch-icon" href="https://cdn-icons-png.flaticon.com/512/2913/2913465.png">

    <!-- é…ç½® Tailwind ä¸»é¢˜ï¼šä½¿ç”¨æŸ”å’Œçš„é¼ å°¾è‰ç»¿/é’è‰²è°ƒ -->
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        sage: {
                            50: '#f2fcf9',
                            100: '#dff9f0',
                            200: '#c0f0e0',
                            300: '#92e2cc',
                            400: '#5bcaba',
                            500: '#38b0a0', // ä¸»è‰²
                            600: '#2a8f83',
                            700: '#25736b',
                            800: '#215c56',
                        }
                    },
                    fontFamily: {
                        sans: ['"PingFang SC"', '"Microsoft YaHei"', 'sans-serif'],
                    }
                }
            }
        }
    </script>

    <style>
        /* è‡ªå®šä¹‰æ»‘å—æ ·å¼ï¼Œä½¿å…¶çœ‹èµ·æ¥æ›´æŸ”å’Œ */
        input[type=range] {
            -webkit-appearance: none; 
            background: transparent; 
        }
        input[type=range]::-webkit-slider-thumb {
            -webkit-appearance: none;
            height: 20px;
            width: 20px;
            border-radius: 50%;
            background: #38b0a0;
            cursor: pointer;
            margin-top: -8px; 
            box-shadow: 0 2px 6px rgba(56, 176, 160, 0.4);
        }
        input[type=range]::-webkit-slider-runnable-track {
            width: 100%;
            height: 4px;
            cursor: pointer;
            background: #e2e8f0;
            border-radius: 2px;
        }
        /* å»é™¤æ•°å­—è¾“å…¥æ¡†çš„ç®­å¤´ï¼Œä¼˜åŒ–ç§»åŠ¨ç«¯ä½“éªŒ */
        input[type=number]::-webkit-inner-spin-button, 
        input[type=number]::-webkit-outer-spin-button { 
            -webkit-appearance: none; 
            margin: 0; 
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-600 font-sans min-h-screen pb-10">

    <!-- é¡¶éƒ¨ Header -->
    <header class="bg-white shadow-sm sticky top-0 z-10">
        <div class="max-w-3xl mx-auto px-6 py-4 flex justify-between items-center">
            <div class="flex items-center gap-2">
                <i class="ph-fill ph-heartbeat text-sage-500 text-2xl"></i>
                <div>
                    <h1 class="text-xl font-bold text-slate-700 tracking-tight leading-none">InnerCalm</h1>
                    <span class="text-[10px] text-slate-400 tracking-wider">ç”Ÿç†ä¸æƒ…ç»ªè¿½è¸ª</span>
                </div>
            </div>
            <!-- é‡ç½®æ•°æ®æŒ‰é’®ï¼Œæ–¹ä¾¿è°ƒè¯•æˆ–é‡ç½® -->
            <button onclick="clearAllData()" class="text-xs text-slate-400 hover:text-red-400 transition-colors">
                é‡ç½®æ•°æ®
            </button>
        </div>
    </header>

    <main class="max-w-3xl mx-auto px-4 py-8 space-y-8">

        <!-- 1. è®°å½•è¯„ä¼°è¡¨å• -->
        <section class="bg-white rounded-2xl shadow-sm border border-slate-100 overflow-hidden">
            <div class="bg-sage-50 px-6 py-3 border-b border-sage-100 flex items-center justify-between">
                <span class="font-semibold text-sage-800 text-sm flex items-center gap-2">
                    <i class="ph-bold ph-plus-circle"></i> æ–°çš„ç»ƒä¹ è®°å½•
                </span>
                <span class="text-xs text-sage-600" id="currentDate"></span>
            </div>
            
            <form id="trackerForm" class="p-6 space-y-8">
                
                <!-- æ–¹æ³•é€‰æ‹© -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">ä½¿ç”¨äº†ä»€ä¹ˆæ”¾æ¾æ–¹æ³•ï¼Ÿ</label>
                    <select id="methodSelect" class="w-full p-3 rounded-xl bg-slate-50 border border-slate-200 focus:border-sage-500 focus:ring-1 focus:ring-sage-500 outline-none transition-all text-slate-700 cursor-pointer">
                        <option value="4-7-8 å‘¼å¸æ³•">ğŸŒ¬ï¸ 4-7-8 å‘¼å¸æ³•</option>
                        <option value="æ¸è¿›å¼è‚Œè‚‰æ”¾æ¾ (PMR)">ğŸ’ª æ¸è¿›å¼è‚Œè‚‰æ”¾æ¾ (PMR)</option>
                        <option value="æ­£å¿µå†¥æƒ³">ğŸ§˜ æ­£å¿µå†¥æƒ³</option>
                        <option value="ç‘œä¼½">ğŸ¤¸ ç‘œä¼½</option>
                        <option value="æœ‰æ°§è¿åŠ¨">ğŸƒ æœ‰æ°§è¿åŠ¨</option>
                        <option value="ä¹¦å†™ç–—æ„ˆ">âœï¸ ä¹¦å†™ç–—æ„ˆ</option>
                        <option value="å¬éŸ³ä¹">ğŸ§ å¬éŸ³ä¹</option>
                        <option value="other">âœ¨ å…¶ä»–...</option>
                    </select>
                    <input type="text" id="customMethodInput" class="mt-2 w-full p-3 rounded-xl bg-white border border-slate-200 focus:border-sage-500 outline-none hidden" placeholder="è¯·è¾“å…¥ä½ çš„æ–¹æ³•åç§°">
                </div>

                <!-- å¯¹æ¯”åŒºåŸŸï¼šBEFORE vs AFTER -->
                <div class="grid grid-cols-1 md:grid-cols-2 gap-8 relative">
                    <!-- åˆ†éš”çº¿ (æ¡Œé¢ç«¯) -->
                    <div class="hidden md:block absolute left-1/2 top-0 bottom-0 w-px bg-slate-100 -ml-px"></div>

                    <!-- Relax Before (æ”¾æ¾å‰) -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-2 pb-2 border-b border-slate-100">
                            <span class="w-2.5 h-2.5 rounded-full bg-slate-400"></span> 
                            <h3 class="font-bold text-slate-700">æ”¾æ¾å‰ (Before)</h3>
                        </div>
                        
                        <!-- ç„¦è™‘åº¦æ»‘å— -->
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-xs font-bold text-slate-500 uppercase">ä¸»è§‚ç„¦è™‘ (SUDs) 0-10</label>
                                <span class="text-lg font-bold text-slate-600 leading-none" id="val-anxiety-before">5</span>
                            </div>
                            <input type="range" id="anxietyBefore" min="0" max="10" value="5" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer">
                        </div>

                        <!-- ç”Ÿç†æŒ‡æ ‡ç»„ (å¿ƒç‡, è¡€å‹) -->
                        <div class="bg-slate-50 p-4 rounded-xl space-y-4">
                            <div class="text-xs font-bold text-slate-400 uppercase tracking-wider mb-1">ç”Ÿç†æŒ‡æ ‡ (é€‰å¡«)</div>
                            
                            <!-- å¿ƒç‡ -->
                            <div class="flex items-center justify-between gap-4">
                                <label class="text-sm text-slate-600 min-w-[40px] flex items-center gap-1"><i class="ph ph-heartbeat text-red-500"></i> å¿ƒç‡</label>
                                <div class="relative w-full">
                                    <input type="number" id="hrBefore" placeholder="BPM" class="w-full p-2 pr-8 text-right rounded-lg border border-slate-200 text-sm focus:border-sage-400 outline-none bg-white">
                                    <span class="absolute right-2 top-2 text-xs text-slate-400">æ¬¡/åˆ†</span>
                                </div>
                            </div>

                            <!-- è¡€å‹ -->
                            <div class="flex items-center justify-between gap-2">
                                <label class="text-sm text-slate-600 min-w-[40px] flex items-center gap-1"><i class="ph ph-hand-tap text-blue-500"></i> è¡€å‹</label>
                                <div class="flex gap-2 w-full">
                                    <input type="number" id="bpSysBefore" placeholder="æ”¶ç¼©å‹" class="w-1/2 p-2 text-center rounded-lg border border-slate-200 text-sm focus:border-sage-400 outline-none bg-white">
                                    <span class="text-slate-300 pt-1">/</span>
                                    <input type="number" id="bpDiaBefore" placeholder="èˆ’å¼ å‹" class="w-1/2 p-2 text-center rounded-lg border border-slate-200 text-sm focus:border-sage-400 outline-none bg-white">
                                    <span class="text-slate-300 pt-1 text-xs">mmHg</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Relax After (æ”¾æ¾å) -->
                    <div class="space-y-6">
                        <div class="flex items-center gap-2 pb-2 border-b border-slate-100">
                            <span class="w-2.5 h-2.5 rounded-full bg-sage-500"></span> 
                            <h3 class="font-bold text-sage-700">æ”¾æ¾å (After)</h3>
                        </div>
                        
                        <!-- ç„¦è™‘åº¦æ»‘å— -->
                        <div>
                            <div class="flex justify-between mb-2">
                                <label class="text-xs font-bold text-slate-500 uppercase">ä¸»è§‚ç„¦è™‘ (SUDs) 0-10</label>
                                <span class="text-lg font-bold text-sage-600 leading-none" id="val-anxiety-after">3</span>
                            </div>
                            <input type="range" id="anxietyAfter" min="0" max="10" value="3" class="w-full h-2 bg-slate-200 rounded-lg appearance-none cursor-pointer accent-sage-500">
                        </div>

                        <!-- ç”Ÿç†æŒ‡æ ‡ç»„ (å¿ƒç‡, è¡€å‹) -->
                        <div class="bg-sage-50/50 p-4 rounded-xl space-y-4 border border-sage-100">
                            <div class="text-xs font-bold text-sage-400 uppercase tracking-wider mb-1">ç”Ÿç†æŒ‡æ ‡ (é€‰å¡«)</div>
                            
                            <!-- å¿ƒç‡ -->
                            <div class="flex items-center justify-between gap-4">
                                <label class="text-sm text-slate-600 min-w-[40px] flex items-center gap-1"><i class="ph ph-heartbeat text-red-500"></i> å¿ƒç‡</label>
                                <div class="relative w-full">
                                    <input type="number" id="hrAfter" placeholder="BPM" class="w-full p-2 pr-8 text-right rounded-lg border border-sage-200 text-sm focus:border-sage-400 focus:ring-1 focus:ring-sage-400 outline-none bg-white">
                                    <span class="absolute right-2 top-2 text-xs text-slate-400">æ¬¡/åˆ†</span>
                                </div>
                            </div>

                            <!-- è¡€å‹ -->
                            <div class="flex items-center justify-between gap-2">
                                <label class="text-sm text-slate-600 min-w-[40px] flex items-center gap-1"><i class="ph ph-hand-tap text-blue-500"></i> è¡€å‹</label>
                                <div class="flex gap-2 w-full">
                                    <input type="number" id="bpSysAfter" placeholder="æ”¶ç¼©å‹" class="w-1/2 p-2 text-center rounded-lg border border-sage-200 text-sm focus:border-sage-400 focus:ring-1 focus:ring-sage-400 outline-none bg-white">
                                    <span class="text-slate-300 pt-1">/</span>
                                    <input type="number" id="bpDiaAfter" placeholder="èˆ’å¼ å‹" class="w-1/2 p-2 text-center rounded-lg border border-sage-200 text-sm focus:border-sage-400 focus:ring-1 focus:ring-sage-400 outline-none bg-white">
                                    <span class="text-slate-300 pt-1 text-xs">mmHg</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- å¤‡æ³¨ (é€‰å¡«) -->
                <div>
                    <label class="text-xs font-bold text-slate-500 uppercase tracking-wide block mb-1">å¤‡æ³¨ / æ„Ÿå— (å¯é€‰)</label>
                    <textarea id="notes" rows="2" class="w-full p-3 rounded-xl bg-slate-50 border-none text-sm focus:ring-1 focus:ring-sage-300 resize-none placeholder-slate-400" placeholder="è®°å½•ä¸‹æ­¤åˆ»çš„æƒ³æ³•ï¼Œæˆ–è€…èº«ä½“çš„å…·ä½“æ„Ÿå—..."></textarea>
                </div>

                <!-- æäº¤æŒ‰é’® -->
                <button type="submit" class="w-full bg-sage-500 hover:bg-sage-600 text-white font-bold py-4 rounded-xl transition-all transform active:scale-[0.99] shadow-lg shadow-sage-200 flex justify-center items-center gap-2 text-base">
                    <i class="ph-bold ph-check-circle text-xl"></i>
                    è®°å½•å¹¶åˆ†æ
                </button>
            </form>
        </section>

        <!-- 2. æ™ºèƒ½åˆ†æä»ªè¡¨ç›˜ -->
        <section id="dashboardSection" class="space-y-8 hidden">
            
            <!-- æ•ˆèƒ½æ’è¡Œæ¦œ -->
            <div>
                <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                    <i class="ph-fill ph-trophy text-yellow-400"></i> æœ€ä½³å‡å‹æ–¹æ³• Top 3
                </h3>
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4" id="leaderboardContainer">
                    <!-- JS åŠ¨æ€æ’å…¥æ’è¡Œæ¦œå¡ç‰‡ -->
                </div>
            </div>

            <!-- è¶‹åŠ¿å›¾è¡¨ -->
            <div class="bg-white p-5 rounded-2xl shadow-sm border border-slate-100">
                <div class="flex justify-between items-center mb-6">
                    <div>
                        <h3 class="font-bold text-slate-700">ç„¦è™‘ç¨‹åº¦å˜åŒ–è¶‹åŠ¿ (SUDs)</h3>
                        <p class="text-xs text-slate-400">è¶Šä½ä»£è¡¨è¶Šå¹³é™</p>
                    </div>
                    <div class="flex gap-4 text-xs font-medium">
                        <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-slate-300"></span>æ”¾æ¾å‰</span>
                        <span class="flex items-center gap-1.5"><span class="w-2.5 h-2.5 rounded-full bg-sage-500"></span>æ”¾æ¾å</span>
                    </div>
                </div>
                <div class="h-64 w-full">
                    <canvas id="trendChart"></canvas>
                </div>
            </div>
        </section>

        <!-- 3. è¯¦ç»†å†å²è®°å½• -->
        <section id="historySection" class="hidden">
            <h3 class="text-lg font-bold text-slate-800 mb-4 flex items-center gap-2">
                <i class="ph-fill ph-clock-counter-clockwise text-slate-400"></i> è¯¦ç»†è®°å½•
            </h3>
            <div id="historyList" class="space-y-4">
                <!-- JS åŠ¨æ€æ’å…¥å†å²è®°å½•å¡ç‰‡ -->
            </div>
        </section>

        <!-- ç©ºçŠ¶æ€æç¤º -->
        <div id="emptyState" class="text-center py-16 opacity-60">
            <div class="w-16 h-16 bg-slate-100 rounded-full flex items-center justify-center mx-auto mb-4">
                <i class="ph-duotone ph-notebook text-3xl text-slate-400"></i>
            </div>
            <p class="text-slate-500 font-medium">æš‚æ— æ•°æ®</p>
            <p class="text-xs text-slate-400 mt-1">å®Œæˆç¬¬ä¸€æ¬¡ç»ƒä¹ æ¥æŸ¥çœ‹åˆ†æ</p>
        </div>

    </main>

    <script>
        // --- å…¨å±€é…ç½®ä¸çŠ¶æ€ç®¡ç† ---
        const STORAGE_KEY = 'anxiety_tracker_data_v2'; 
        let entries = JSON.parse(localStorage.getItem(STORAGE_KEY)) || [];
        let chartInstance = null;

        // --- UI äº‹ä»¶ç»‘å®š ---
        const dateDisplay = document.getElementById('currentDate');
        dateDisplay.textContent = new Date().toLocaleDateString('zh-CN', { month: 'long', day: 'numeric', weekday: 'long' });

        // ç»‘å®šæ»‘å—æ•°å€¼æ˜¾ç¤º
        ['anxietyBefore', 'anxietyAfter'].forEach(id => {
            const el = document.getElementById(id);
            const display = document.getElementById(`val-${id.replace(/[A-Z]/g, l => '-' + l.toLowerCase())}`);
            el.addEventListener('input', (e) => {
                display.textContent = e.target.value;
                if(id === 'anxietyAfter') {
                    // æ”¾æ¾ååˆ†æ•°ä½ï¼Œé¢œè‰²æ›´ç§¯æ
                    display.className = e.target.value < 4 
                        ? "text-lg font-bold text-sage-600 leading-none" 
                        : "text-lg font-bold text-yellow-600 leading-none";
                }
            });
        });

        // æ–¹æ³•é€‰æ‹©è”åŠ¨
        const methodSelect = document.getElementById('methodSelect');
        const customMethodInput = document.getElementById('customMethodInput');
        methodSelect.addEventListener('change', (e) => {
            customMethodInput.classList.toggle('hidden', e.target.value !== 'other');
            if (e.target.value === 'other') customMethodInput.focus();
        });

        // --- æ ¸å¿ƒé€»è¾‘ï¼šæ•°æ®å­˜å‚¨ä¸è®¡ç®— ---

        // æäº¤å¤„ç†
        document.getElementById('trackerForm').addEventListener('submit', (e) => {
            e.preventDefault();

            let method = methodSelect.value === 'other' ? (customMethodInput.value.trim() || 'è‡ªå®šä¹‰') : methodSelect.value;

            // è¾…åŠ©å‡½æ•°ï¼šè§£ææ•°å­—è¾“å…¥ï¼Œä¸ºç©ºåˆ™è¿”å› null
            const parseNum = (id) => {
                const val = document.getElementById(id).value;
                return val ? parseInt(val) : null;
            };

            const newEntry = {
                id: Date.now(),
                timestamp: new Date().toISOString(),
                method: method,
                sudsBefore: parseNum('anxietyBefore') || 0,
                sudsAfter: parseNum('anxietyAfter') || 0,
                
                // ç”Ÿç†æ•°æ®
                hrBefore: parseNum('hrBefore'),
                hrAfter: parseNum('hrAfter'),
                bpSysBefore: parseNum('bpSysBefore'),
                bpDiaBefore: parseNum('bpDiaBefore'),
                bpSysAfter: parseNum('bpSysAfter'),
                bpDiaAfter: parseNum('bpDiaAfter'),
                
                notes: document.getElementById('notes').value.trim()
            };

            // è®¡ç®—ä¸»è¦æŒ‡æ ‡å˜åŒ–
            newEntry.sudsDrop = newEntry.sudsBefore - newEntry.sudsAfter;

            entries.unshift(newEntry);
            localStorage.setItem(STORAGE_KEY, JSON.stringify(entries));

            resetForm();
            renderApp();
            
            // ç®€å•åé¦ˆ
            const btn = e.submitter;
            const originalText = btn.innerHTML;
            btn.innerHTML = `<i class="ph-bold ph-check"></i> å·²ä¿å­˜`;
            btn.classList.add('bg-green-600');
            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.classList.remove('bg-green-600');
            }, 2000);
        });

        function resetForm() {
            document.getElementById('trackerForm').reset();
            // é‡ç½®æ»‘å—çš„æ˜¾ç¤ºå€¼åˆ°é»˜è®¤
            document.getElementById('anxietyBefore').value = '5';
            document.getElementById('anxietyAfter').value = '3';
            document.getElementById('val-anxiety-before').textContent = '5';
            document.getElementById('val-anxiety-after').textContent = '3';
            methodSelect.value = "4-7-8 å‘¼å¸æ³•";
            customMethodInput.classList.add('hidden');
        }

        // --- UI æ¸²æŸ“é€»è¾‘ ---

        function renderApp() {
            const hasData = entries.length > 0;
            document.getElementById('emptyState').classList.toggle('hidden', hasData);
            document.getElementById('dashboardSection').classList.toggle('hidden', !hasData);
            document.getElementById('historySection').classList.toggle('hidden', !hasData);

            if (hasData) {
                renderHistory();
                renderStats();
                renderChart();
            }
        }

        function renderHistory() {
            const container = document.getElementById('historyList');
            container.innerHTML = '';

            entries.slice(0, 20).forEach(entry => { // æ˜¾ç¤ºæœ€è¿‘20æ¡
                const date = new Date(entry.timestamp);
                const timeStr = date.toLocaleTimeString('zh-CN', { hour: '2-digit', minute: '2-digit' });
                const dateStr = date.toLocaleDateString('zh-CN', { month: '2-digit', day: '2-digit' });

                // æ„å»ºç”Ÿç†æ•°æ®å˜åŒ– UI
                let physioHtml = '';
                
                // å¿ƒç‡æ˜¾ç¤º
                if (entry.hrBefore && entry.hrAfter) {
                    const diff = entry.hrBefore - entry.hrAfter;
                    const colorClass = diff > 0 ? 'text-sage-600' : (diff < 0 ? 'text-red-400' : 'text-slate-400'); // å¿ƒç‡ä¸‹é™æ˜¯å¥½çš„
                    physioHtml += `
                        <div class="flex justify-between items-center text-xs mt-1">
                            <span class="text-slate-400 w-12">å¿ƒç‡</span>
                            <span class="font-mono text-slate-600">${entry.hrBefore}â†’${entry.hrAfter}</span>
                            <span class="${colorClass} w-8 text-right font-medium">${diff > 0 ? 'â†“'+diff : (diff < 0 ? 'â†‘'+Math.abs(diff) : '-')}</span>
                        </div>`;
                }

                // è¡€å‹æ˜¾ç¤º
                if (entry.bpSysBefore && entry.bpSysAfter) {
                    const sysDiff = entry.bpSysBefore - entry.bpSysAfter;
                    const diaDiff = entry.bpDiaBefore - entry.bpDiaAfter;
                    // ä»¥æ”¶ç¼©å‹ä¸‹é™ä¸ºä¸»è¦ç§¯ææŒ‡æ ‡
                    const colorClass = sysDiff > 0 ? 'text-sage-600' : 'text-slate-400';
                    
                    physioHtml += `
                        <div class="flex justify-between items-center text-xs mt-1">
                            <span class="text-slate-400 w-12">è¡€å‹</span>
                            <span class="font-mono text-slate-600 tracking-tighter">
                                ${entry.bpSysBefore}/${entry.bpDiaBefore}â†’${entry.bpSysAfter}/${entry.bpDiaAfter}
                            </span>
                            <span class="${colorClass} w-8 text-right font-medium">${sysDiff > 0 ? 'â†“' : ''}</span>
                        </div>`;
                }

                // å¦‚æœæ²¡æœ‰ç”Ÿç†æ•°æ®ï¼Œæ˜¾ç¤ºæç¤º
                if (!physioHtml) physioHtml = '<div class="text-xs text-slate-300 italic mt-1">æœªè®°å½•ç”Ÿç†æŒ‡æ ‡</div>';

                const sudsDropBadge = entry.sudsDrop > 0 
                    ? `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-sage-100 text-sage-700">ä¸‹é™ ${entry.sudsDrop} ç‚¹</span>`
                    : `<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-slate-100 text-slate-500">æŒå¹³/ç•¥å‡</span>`;


                const html = `
                    <div class="bg-white p-4 rounded-xl shadow-sm border border-slate-100 hover:shadow-md transition-all">
                        <div class="flex flex-col md:flex-row gap-4">
                            <!-- å·¦ä¾§ï¼šæ–¹æ³•ä¸å¤‡æ³¨ -->
                            <div class="flex items-center md:items-start gap-3 md:w-1/3 shrink-0">
                                <div class="w-10 h-10 rounded-full bg-sage-50 flex items-center justify-center text-xl shrink-0">
                                    ${getMethodIcon(entry.method)}
                                </div>
                                <div>
                                    <h4 class="font-bold text-slate-700 text-sm leading-tight mb-0.5">${entry.method}</h4>
                                    <p class="text-xs text-slate-400">${dateStr} ${timeStr}</p>
                                    ${entry.notes ? `<p class="text-xs text-slate-500 mt-1 bg-slate-50 p-1.5 rounded line-clamp-2">${entry.notes}</p>` : ''}
                                </div>
                            </div>

                            <!-- ä¸­é—´ï¼šç„¦è™‘æŒ‡æ•°å˜åŒ– (æ ¸å¿ƒæŒ‡æ ‡) -->
                            <div class="flex-1 border-t md:border-t-0 md:border-l border-slate-100 pt-3 md:pt-0 md:pl-4 flex flex-col justify-center">
                                <div class="flex justify-between items-center mb-2">
                                    <span class="text-xs font-bold text-slate-400 uppercase">ç„¦è™‘åº¦ (SUDs)</span>
                                    ${sudsDropBadge}
                                </div>
                                <div class="flex items-center gap-2">
                                    <!-- è¿›åº¦æ¡å¯è§†åŒ– SUDs -->
                                    <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden flex">
                                        <div class="bg-slate-300 h-full" style="width: ${entry.sudsBefore * 10}%"></div>
                                    </div>
                                    <i class="ph-bold ph-arrow-right text-slate-300 text-xs"></i>
                                    <div class="flex-1 h-2 bg-slate-100 rounded-full overflow-hidden flex">
                                        <div class="bg-sage-500 h-full" style="width: ${entry.sudsAfter * 10}%"></div>
                                    </div>
                                </div>
                                <div class="flex justify-between text-xs text-slate-500 mt-1 font-mono">
                                    <span>${entry.sudsBefore}</span>
                                    <span>${entry.sudsAfter}</span>
                                </div>
                            </div>

                            <!-- å³ä¾§ï¼šç”Ÿç†æ•°æ® -->
                            <div class="md:w-1/3 border-t md:border-t-0 md:border-l border-slate-100 pt-3 md:pt-0 md:pl-4">
                                <div class="text-[10px] font-bold text-slate-400 uppercase mb-1">ç”Ÿç†å˜åŒ–</div>
                                ${physioHtml}
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
        }

        function renderStats() {
            const methodStats = {};

            // èšåˆæ•°æ®ï¼Œè®¡ç®—å¹³å‡ä¸‹é™å€¼
            entries.forEach(e => {
                if (!methodStats[e.method]) {
                    methodStats[e.method] = { count: 0, totalDrop: 0, method: e.method };
                }
                methodStats[e.method].count++;
                methodStats[e.method].totalDrop += e.sudsDrop;
            });

            // æ’åºå¹¶å–å‰3
            const ranking = Object.values(methodStats)
                .map(item => ({
                    ...item,
                    avgDrop: (item.totalDrop / item.count).toFixed(1)
                }))
                .filter(item => item.count >= 1 && item.avgDrop > 0) // è¿‡æ»¤æ‰æ— æ•ˆæ–¹æ³•
                .sort((a, b) => b.avgDrop - a.avgDrop)
                .slice(0, 3);

            const container = document.getElementById('leaderboardContainer');
            container.innerHTML = '';

            ranking.forEach((item, index) => {
                const html = `
                    <div class="bg-sage-50/50 border border-sage-100 p-4 rounded-xl flex items-center justify-between relative overflow-hidden">
                        <div class="absolute -right-4 -top-4 text-6xl opacity-10 select-none">${getMethodIcon(item.method)}</div>
                        <div>
                            <div class="text-xs text-sage-600 font-bold mb-1">No.${index + 1} æ¨è</div>
                            <div class="font-bold text-slate-700 truncate max-w-[100px] sm:max-w-full">${item.method}</div>
                            <div class="text-[10px] text-slate-400 mt-1">å·²ç»ƒä¹  ${item.count} æ¬¡</div>
                        </div>
                        <div class="text-right z-10">
                            <div class="text-xl font-bold text-sage-600">-${item.avgDrop}</div>
                            <div class="text-[10px] text-sage-400">å¹³å‡é™å¹…</div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', html);
            });
            // å¦‚æœæ’è¡Œæ¦œä¸ºç©ºï¼Œæ·»åŠ ä¸€ä¸ªå‹å¥½çš„æç¤º
            if(ranking.length === 0) {
                 container.innerHTML = '<div class="col-span-full text-center py-4 text-slate-400 text-sm">ç›®å‰è¿˜æ²¡æœ‰äº§ç”Ÿç§¯ææ•ˆæœçš„æ•°æ®ï¼Œç»§ç»­å°è¯•ï¼</div>';
            }
        }

        function renderChart() {
            const ctx = document.getElementById('trendChart').getContext('2d');
            const chartData = [...entries].reverse().slice(-15); // æ˜¾ç¤ºæœ€è¿‘15æ¬¡è®°å½•
            
            const labels = chartData.map(e => {
                const d = new Date(e.timestamp);
                return `${d.getMonth()+1}/${d.getDate()}`;
            });
            const dataBefore = chartData.map(e => e.sudsBefore);
            const dataAfter = chartData.map(e => e.sudsAfter);

            if (chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'æ”¾æ¾å‰',
                            data: dataBefore,
                            borderColor: '#cbd5e1', // ç°è‰²
                            borderWidth: 2,
                            borderDash: [4, 4],
                            pointRadius: 0,
                            pointHoverRadius: 4,
                            tension: 0.3
                        },
                        {
                            label: 'æ”¾æ¾å',
                            data: dataAfter,
                            borderColor: '#38b0a0', // ç»¿è‰²
                            backgroundColor: 'rgba(56, 176, 160, 0.05)',
                            borderWidth: 2,
                            fill: true,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#38b0a0',
                            pointRadius: 4,
                            tension: 0.3
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    interaction: { mode: 'index', intersect: false },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            backgroundColor: 'rgba(255, 255, 255, 0.95)',
                            titleColor: '#1e293b',
                            bodyColor: '#475569',
                            borderColor: '#e2e8f0',
                            borderWidth: 1,
                            padding: 12,
                            displayColors: true,
                            boxWidth: 8,
                            callbacks: {
                                afterBody: function(tooltipItems) {
                                    // åœ¨ Tooltip ä¸­æ˜¾ç¤ºç”Ÿç†æ•°æ®è¯¦æƒ…
                                    const index = tooltipItems[0].dataIndex;
                                    const entry = chartData[index];
                                    let lines = [];
                                    if(entry.hrBefore && entry.hrAfter) {
                                        const hrDrop = entry.hrBefore - entry.hrAfter;
                                        lines.push(`å¿ƒç‡: ${entry.hrBefore}â†’${entry.hrAfter} (${hrDrop > 0 ? 'â†“'+hrDrop : (hrDrop < 0 ? 'â†‘'+Math.abs(hrDrop) : 'æ— å˜åŒ–')})`);
                                    }
                                    if(entry.bpSysBefore && entry.bpSysAfter) {
                                        lines.push(`è¡€å‹: ${entry.bpSysBefore}/${entry.bpDiaBefore}â†’${entry.bpSysAfter}/${entry.bpDiaAfter}`);
                                    }
                                    return lines.length ? '\n\nâ€” ç”Ÿç†æ•°æ® â€”\n' + lines.join('\n') : '';
                                }
                            }
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            max: 10,
                            grid: { color: '#f8fafc' },
                            ticks: { font: {size: 10}, stepSize: 2 }
                        },
                        x: {
                            grid: { display: false },
                            ticks: { font: {size: 10}, maxRotation: 0 }
                        }
                    }
                }
            });
        }

        // è¾…åŠ©å‡½æ•°ï¼šæ ¹æ®æ–¹æ³•åè¿”å› emoji å›¾æ ‡
        function getMethodIcon(method) {
            if (method.includes('å‘¼å¸')) return 'ğŸŒ¬ï¸';
            if (method.includes('è‚Œè‚‰')) return 'ğŸ’ª';
            if (method.includes('å†¥æƒ³')) return 'ğŸ§˜';
            if (method.includes('ç‘œä¼½')) return 'ğŸ¤¸';
            if (method.includes('è¿åŠ¨')) return 'ğŸƒ';
            if (method.includes('ä¹¦å†™')) return 'âœï¸';
            if (method.includes('éŸ³ä¹')) return 'ğŸ§';
            return 'âœ¨';
        }

        // æ¸…é™¤æ‰€æœ‰æ•°æ®
        function clearAllData() {
            // ä½¿ç”¨è‡ªå®šä¹‰æ¨¡æ€æ¡†ä»£æ›¿ alert(), ç¡®ä¿åœ¨ App ç¯å¢ƒä¸­å¯ç”¨æ€§
            const confirmation = window.confirm('ç¡®å®šè¦æ¸…é™¤æ‰€æœ‰å†å²è®°å½•å—ï¼Ÿæ­¤æ“ä½œæ— æ³•æ’¤é”€ã€‚');
            if(confirmation) {
                localStorage.removeItem(STORAGE_KEY);
                entries = [];
                renderApp();
            }
        }

        // é¦–æ¬¡åŠ è½½åº”ç”¨
        renderApp();
    </script>
</body>
</html>