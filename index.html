<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>é­”æ³•åˆæˆå±‹ âœ¨ Magic Merge</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Matter.js ç‰©ç†å¼•æ“ -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/matter-js/0.19.0/matter.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Fredoka:wght@400;600&display=swap');

        body {
            font-family: 'Fredoka', sans-serif;
            background: linear-gradient(135deg, #1a1c2c 0%, #4a192c 50%, #1a1c2c 100%);
            overflow: hidden;
            touch-action: none; /* ç¦æ­¢ç§»åŠ¨ç«¯é»˜è®¤æ»šåŠ¨ */
            color: white;
        }

        #game-container {
            position: relative;
            box-shadow: 0 0 50px rgba(255, 105, 180, 0.3);
            border-radius: 12px;
            overflow: hidden;
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(5px);
            border: 2px solid rgba(255, 255, 255, 0.1);
        }

        canvas {
            display: block;
            width: 100%;
            height: 100%;
        }

        .ui-overlay {
            position: absolute;
            pointer-events: none;
            width: 100%;
            height: 100%;
            top: 0;
            left: 0;
            display: flex;
            flex-direction: column;
            justify-content: space-between;
            padding: 1rem;
        }

        .score-box {
            background: rgba(255, 255, 255, 0.2);
            padding: 8px 16px;
            border-radius: 20px;
            font-size: 1.5rem;
            font-weight: 600;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
            display: inline-block;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }

        #next-item-display {
            position: absolute;
            top: 1rem;
            right: 1rem;
            background: rgba(255, 255, 255, 0.2);
            padding: 8px;
            border-radius: 50%;
            width: 50px;
            height: 50px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            border: 2px solid rgba(255, 255, 255, 0.3);
        }

        #game-over-screen {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.85);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 50;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        #game-over-screen.active {
            opacity: 1;
            pointer-events: all;
        }

        .btn-restart {
            margin-top: 20px;
            background: linear-gradient(45deg, #ff6b6b, #feca57);
            border: none;
            padding: 12px 30px;
            border-radius: 30px;
            font-size: 1.2rem;
            color: white;
            font-weight: bold;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(255, 107, 107, 0.4);
            transition: transform 0.2s;
            pointer-events: auto;
        }

        .btn-restart:hover {
            transform: scale(1.05);
        }

        .btn-sound {
            position: absolute;
            bottom: 1rem;
            left: 1rem;
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            color: white;
            cursor: pointer;
            pointer-events: auto;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* ç®€å•çš„é—ªçƒåŠ¨ç”»ï¼Œç”¨äºæç¤ºçº¿ */
        @keyframes pulse {
            0% { opacity: 0.3; }
            50% { opacity: 0.8; }
            100% { opacity: 0.3; }
        }
    </style>
</head>
<body class="h-screen w-screen flex items-center justify-center">

    <!-- æ¸¸æˆä¸»å®¹å™¨ -->
    <div id="game-container" class="w-full max-w-md h-[85vh] sm:h-[600px] sm:w-[400px]">
        
        <canvas id="world"></canvas>
        
        <!-- UI å±‚ -->
        <div class="ui-overlay">
            <div class="flex justify-between items-start w-full">
                <div class="score-box">
                    âœ¨ <span id="score">0</span>
                </div>
                <div id="next-item-display">
                    <span id="next-emoji">âœ¨</span>
                </div>
            </div>
            
            <button id="sound-btn" class="btn-sound">
                ğŸ”Š
            </button>
        </div>

        <!-- æ¸¸æˆç»“æŸå±å¹• -->
        <div id="game-over-screen">
            <h1 class="text-4xl font-bold mb-2 text-pink-400">å“å‘€ï¼</h1>
            <p class="text-xl mb-4">æº¢å‡ºæ¥äº†ï½</p>
            <div class="text-2xl font-bold bg-white/10 px-6 py-2 rounded-lg">
                æœ€ç»ˆå¾—åˆ†: <span id="final-score">0</span>
            </div>
            <button class="btn-restart" onclick="resetGame()">å†è¯•ä¸€æ¬¡ ğŸŒ¸</button>
        </div>
    </div>

    <script>
        // --- æ¸¸æˆé…ç½® ---
        // å®šä¹‰ä¸åŒç­‰çº§çš„ç‰©å“ï¼šåŠå¾„ã€Emojiã€åˆ†æ•°
        const TIERS = [
            { radius: 15, emoji: 'âœ¨', score: 2, color: '#FFD700' },    // 0: æ˜Ÿæ˜Ÿ (æœ€å°)
            { radius: 22, emoji: 'ğŸ¬', score: 4, color: '#FF69B4' },    // 1: ç³–æœ
            { radius: 30, emoji: 'ğŸŒ¸', score: 8, color: '#FFB7C5' },    // 2: æ¨±èŠ±
            { radius: 38, emoji: 'ğŸ„', score: 16, color: '#FF4500' },   // 3: è˜‘è‡
            { radius: 48, emoji: 'ğŸ”®', score: 32, color: '#9370DB' },   // 4: æ°´æ™¶çƒ
            { radius: 60, emoji: 'ğŸ’', score: 64, color: '#00BFFF' },   // 5: å®çŸ³
            { radius: 72, emoji: 'ğŸ¦„', score: 128, color: '#E6E6FA' },  // 6: ç‹¬è§’å…½
            { radius: 85, emoji: 'ğŸŒ™', score: 256, color: '#FFFFE0' },  // 7: æœˆäº®
            { radius: 100, emoji: 'ğŸŒ', score: 512, color: '#FFA500' }, // 8: å¤ªé˜³
            { radius: 120, emoji: 'ğŸ‘‘', score: 1024, color: '#FFD700' } // 9: çš‡å†  (æœ€å¤§)
        ];

        // --- ç‰©ç†å¼•æ“è®¾ç½® ---
        const Engine = Matter.Engine,
              Render = Matter.Render,
              Runner = Matter.Runner,
              Bodies = Matter.Bodies,
              Composite = Matter.Composite,
              Events = Matter.Events,
              World = Matter.World,
              Body = Matter.Body;

        let engine;
        let render;
        let runner;
        let canvas;
        let ctx;
        let width, height;
        
        // æ¸¸æˆçŠ¶æ€
        let currentItem = null;
        let nextTier = 0;
        let score = 0;
        let isGameOver = false;
        let canDrop = true;
        let particles = [];
        let soundEnabled = true;
        const WALL_THICKNESS = 50;
        const DANGER_LINE_Y = 100; // å±é™©çº¿é«˜åº¦

        // --- éŸ³æ•ˆåˆæˆå™¨ (Web Audio API) ---
        // è¿™æ ·å°±ä¸éœ€è¦åŠ è½½å¤–éƒ¨æ–‡ä»¶ï¼Œä¿è¯å£°éŸ³ç«‹åˆ»èƒ½ç”¨
        const audioCtx = new (window.AudioContext || window.webkitAudioContext)();
        
        function playTone(freq, type, duration) {
            if (!soundEnabled || audioCtx.state === 'suspended') {
                audioCtx.resume();
            }
            if (!soundEnabled) return;

            const osc = audioCtx.createOscillator();
            const gainNode = audioCtx.createGain();

            osc.type = type;
            osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
            
            gainNode.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + duration);

            osc.connect(gainNode);
            gainNode.connect(audioCtx.destination);

            osc.start();
            osc.stop(audioCtx.currentTime + duration);
        }

        const sounds = {
            drop: () => playTone(300, 'triangle', 0.1),
            merge: () => {
                // æ’­æ”¾ä¸€æ®µå¥½å¬çš„å’Œå¼¦
                playTone(440, 'sine', 0.3); // A4
                setTimeout(() => playTone(554, 'sine', 0.3), 50); // C#5
                setTimeout(() => playTone(659, 'sine', 0.3), 100); // E5
            },
            pop: () => playTone(800, 'sine', 0.1),
            gameOver: () => {
                playTone(200, 'sawtooth', 0.5);
                setTimeout(() => playTone(150, 'sawtooth', 0.5), 200);
            }
        };

        // --- åˆå§‹åŒ–æ¸¸æˆ ---
        function init() {
            const container = document.getElementById('game-container');
            canvas = document.getElementById('world');
            width = container.clientWidth;
            height = container.clientHeight;

            // è®¾ç½® Canvas åˆ†è¾¨ç‡ (Retina å±ä¼˜åŒ–)
            const dpr = window.devicePixelRatio || 1;
            canvas.width = width * dpr;
            canvas.height = height * dpr;
            ctx = canvas.getContext('2d');
            ctx.scale(dpr, dpr);

            // åˆ›å»ºå¼•æ“
            engine = Engine.create();
            // ä¿®æ”¹é‡åŠ›ï¼Œè®©æ‰‹æ„Ÿæ›´åƒâ€œæ°”çƒâ€æˆ–â€œæœå†»â€
            engine.world.gravity.y = 1.2; 

            // åˆ›å»ºå¢™å£
            const ground = Bodies.rectangle(width/2, height + WALL_THICKNESS/2, width, WALL_THICKNESS, { isStatic: true, render: { visible: false } });
            const leftWall = Bodies.rectangle(0 - WALL_THICKNESS/2, height/2, WALL_THICKNESS, height * 2, { isStatic: true, render: { visible: false } });
            const rightWall = Bodies.rectangle(width + WALL_THICKNESS/2, height/2, WALL_THICKNESS, height * 2, { isStatic: true, render: { visible: false } });

            World.add(engine.world, [ground, leftWall, rightWall]);

            // å¯åŠ¨ Runner
            runner = Runner.create();
            Runner.run(runner, engine);

            // ç¢°æ’æ£€æµ‹ç›‘å¬
            Events.on(engine, 'collisionStart', handleCollisions);

            // è¾“å…¥ç›‘å¬
            setupInputs(container);

            // è‡ªå®šä¹‰æ¸²æŸ“å¾ªç¯
            requestAnimationFrame(renderLoop);

            // ç”Ÿæˆç¬¬ä¸€ä¸ªé¢„å¤‡ç‰©å“
            prepareNextItem();
            updateScore(0);
        }

        // --- æ¸¸æˆé€»è¾‘ ---

        function prepareNextItem() {
            // éšæœºç”Ÿæˆ 0 åˆ° 3 çº§çš„ç‰©å“
            nextTier = Math.floor(Math.random() * 4);
            // æ›´æ–° UI é¢„è§ˆ
            document.getElementById('next-emoji').innerText = TIERS[nextTier].emoji;
        }

        function spawnCurrentItem(x) {
            if (!canDrop || isGameOver) return;
            
            canDrop = false; // å†·å´é˜²æ­¢è¿ç‚¹
            sounds.drop();

            // é™åˆ¶ X åæ ‡ï¼Œé˜²æ­¢ç”Ÿæˆåœ¨å¢™é‡Œ
            const radius = TIERS[nextTier].radius;
            x = Math.max(radius + 5, Math.min(width - radius - 5, x));

            const body = Bodies.circle(x, 50, radius, {
                restitution: 0.3, // å¼¹æ€§
                friction: 0.1,
                label: `item-${nextTier}`, // æ ‡è®°ç­‰çº§
                render: {
                    fillStyle: TIERS[nextTier].color
                }
            });
            
            // å­˜å‚¨è‡ªå®šä¹‰å±æ€§
            body.tier = nextTier;
            body.emoji = TIERS[nextTier].emoji;

            World.add(engine.world, body);

            // å†·å´æ—¶é—´
            setTimeout(() => {
                canDrop = true;
            }, 600);

            prepareNextItem();
        }

        function handleCollisions(event) {
            const pairs = event.pairs;

            for (let i = 0; i < pairs.length; i++) {
                const bodyA = pairs[i].bodyA;
                const bodyB = pairs[i].bodyB;

                // æ£€æŸ¥æ˜¯å¦éƒ½æ˜¯æ¸¸æˆç‰©å“ä¸”ç­‰çº§ç›¸åŒ
                if (bodyA.tier !== undefined && bodyB.tier !== undefined && bodyA.tier === bodyB.tier) {
                    // é˜²æ­¢åŒä¸€å¸§å¤šæ¬¡å¤„ç†
                    if(bodyA.isRemoved || bodyB.isRemoved) continue;

                    const newTier = bodyA.tier + 1;
                    
                    // å¦‚æœå·²ç»æ˜¯æœ€é«˜çº§ï¼Œå°±ä¸å†åˆæˆäº†ï¼ˆæˆ–è€…ä½ å¯ä»¥è®¾å®šæ¶ˆé™¤ï¼‰
                    if (newTier >= TIERS.length) {
                         // è¿™é‡Œå¯ä»¥æ˜¯æ¶ˆé™¤å¹¶åŠ å·¨åˆ†
                         createParticles(bodyA.position.x, bodyA.position.y, TIERS[bodyA.tier].color, 20);
                         World.remove(engine.world, [bodyA, bodyB]);
                         bodyA.isRemoved = true; 
                         bodyB.isRemoved = true;
                         updateScore(score + TIERS[bodyA.tier].score * 2);
                         sounds.merge();
                         continue;
                    }

                    // è®¡ç®—æ–°ä½ç½®ï¼ˆä¸­ç‚¹ï¼‰
                    const midX = (bodyA.position.x + bodyB.position.x) / 2;
                    const midY = (bodyA.position.y + bodyB.position.y) / 2;

                    // ç§»é™¤æ—§ç‰©ä½“
                    World.remove(engine.world, [bodyA, bodyB]);
                    bodyA.isRemoved = true; // æ ‡è®°åˆ é™¤é˜²æ­¢é‡å¤è®¡ç®—
                    bodyB.isRemoved = true;

                    // åˆ›å»ºæ–°ç‰©ä½“
                    const newRadius = TIERS[newTier].radius;
                    const newBody = Bodies.circle(midX, midY, newRadius, {
                        restitution: 0.2,
                        label: `item-${newTier}`
                    });
                    newBody.tier = newTier;
                    newBody.emoji = TIERS[newTier].emoji;

                    World.add(engine.world, newBody);

                    // ç‰¹æ•ˆä¸åˆ†æ•°
                    createParticles(midX, midY, TIERS[newTier].color, 10);
                    updateScore(score + TIERS[newTier].score);
                    sounds.merge();
                }
            }
        }

        // --- è¾“å…¥å¤„ç† ---
        function setupInputs(element) {
            let currentX = width / 2;

            const handleMove = (e) => {
                if(isGameOver) return;
                const rect = element.getBoundingClientRect();
                const clientX = e.touches ? e.touches[0].clientX : e.clientX;
                currentX = clientX - rect.left;
            };

            const handleEnd = (e) => {
                if(isGameOver) return;
                spawnCurrentItem(currentX);
            };

            element.addEventListener('mousemove', handleMove);
            element.addEventListener('touchmove', handleMove, {passive: false}); // passive false å…è®¸ preventDefault

            element.addEventListener('mouseup', handleEnd);
            element.addEventListener('touchend', handleEnd);
            
            // è®°å½•é¼ æ ‡/æ‰‹æŒ‡ä½ç½®ç»™æ¸²æŸ“å¾ªç¯ç”¨ï¼Œç”¨æ¥ç”»è¾…åŠ©çº¿
            element.currentInputX = () => currentX;
        }

        // --- è§†è§‰æ•ˆæœ ---
        
        function createParticles(x, y, color, count) {
            for(let i=0; i<count; i++) {
                particles.push({
                    x: x,
                    y: y,
                    vx: (Math.random() - 0.5) * 10,
                    vy: (Math.random() - 0.5) * 10,
                    life: 1.0,
                    color: color,
                    size: Math.random() * 4 + 2
                });
            }
        }

        function updateScore(newScore) {
            score = newScore;
            document.getElementById('score').innerText = score;
        }

        function checkGameOver() {
            const bodies = Composite.allBodies(engine.world);
            for (let i = 0; i < bodies.length; i++) {
                const body = bodies[i];
                if (!body.isStatic && body.position.y < DANGER_LINE_Y && body.velocity.y > -0.1 && body.velocity.y < 0.1) {
                    // å¦‚æœç‰©ä½“é™æ­¢åœ¨å±é™©çº¿ä»¥ä¸Šï¼Œæ¸¸æˆç»“æŸ
                    // åŠ ä¸Šä¸€ç‚¹å»¶è¿Ÿåˆ¤å®šï¼Œé˜²æ­¢åˆšç”Ÿæˆæ—¶è¯¯åˆ¤
                    if(body.lifeTime && Date.now() - body.lifeTime > 1000) {
                         // çœŸæ­£çš„æ¸¸æˆç»“æŸé€»è¾‘
                         isGameOver = true;
                         document.getElementById('game-over-screen').classList.add('active');
                         document.getElementById('final-score').innerText = score;
                         sounds.gameOver();
                         return;
                    }
                    if(!body.lifeTime) body.lifeTime = Date.now();
                }
            }
        }

        // --- æ¸²æŸ“å¾ªç¯ (æ ¸å¿ƒ) ---
        function renderLoop() {
            // 1. æ¸…ç©ºç”»å¸ƒ
            ctx.clearRect(0, 0, width, height);

            // 2. ç»˜åˆ¶å±é™©çº¿
            ctx.beginPath();
            ctx.moveTo(0, DANGER_LINE_Y);
            ctx.lineTo(width, DANGER_LINE_Y);
            ctx.strokeStyle = "rgba(255, 100, 100, 0.3)";
            ctx.setLineDash([10, 10]);
            ctx.lineWidth = 2;
            ctx.stroke();
            ctx.setLineDash([]);

            // 3. ç»˜åˆ¶è¾…åŠ©çº¿å’Œé¢„å¤‡ç‰©å“ (å¦‚æœæœªç»“æŸ)
            if (!isGameOver) {
                const inputX = document.getElementById('game-container').currentInputX ? document.getElementById('game-container').currentInputX() : width/2;
                // é™åˆ¶è¾…åŠ©çº¿èŒƒå›´
                const clampX = Math.max(TIERS[nextTier].radius, Math.min(width - TIERS[nextTier].radius, inputX));
                
                // è™šçº¿
                ctx.beginPath();
                ctx.moveTo(clampX, 50);
                ctx.lineTo(clampX, height);
                ctx.strokeStyle = "rgba(255, 255, 255, 0.1)";
                ctx.lineWidth = 1;
                ctx.stroke();

                // æ‚¬åœçš„ç‰©å“
                if(canDrop) {
                    ctx.globalAlpha = 0.8;
                    const r = TIERS[nextTier].radius;
                    ctx.fillStyle = TIERS[nextTier].color;
                    ctx.beginPath();
                    ctx.arc(clampX, 50, r, 0, Math.PI*2);
                    ctx.fill();
                    
                    ctx.font = `${r}px Fredoka`;
                    ctx.fillStyle = "#FFF";
                    ctx.textAlign = "center";
                    ctx.textBaseline = "middle";
                    ctx.fillText(TIERS[nextTier].emoji, clampX, 50 + r * 0.1);
                    ctx.globalAlpha = 1.0;
                }
            }

            // 4. ç»˜åˆ¶ç‰©ç†ä¸–ç•Œçš„ç‰©ä½“
            const bodies = Composite.allBodies(engine.world);
            ctx.textAlign = "center";
            ctx.textBaseline = "middle";

            for (let i = 0; i < bodies.length; i += 1) {
                const body = bodies[i];
                if (body.isStatic) continue; // ä¸ç”»å¢™å£

                const r = body.circleRadius;
                
                ctx.translate(body.position.x, body.position.y);
                ctx.rotate(body.angle);

                // ç”»åœ†çƒèƒŒæ™¯
                ctx.beginPath();
                ctx.arc(0, 0, r, 0, 2 * Math.PI);
                ctx.fillStyle = TIERS[body.tier].color;
                ctx.shadowColor = TIERS[body.tier].color;
                ctx.shadowBlur = 10;
                ctx.fill();
                ctx.shadowBlur = 0; // é‡ç½®é˜´å½±

                // é«˜å…‰æ•ˆæœ (è®©çƒçœ‹èµ·æ¥ç«‹ä½“)
                ctx.beginPath();
                ctx.arc(-r*0.3, -r*0.3, r*0.2, 0, 2*Math.PI);
                ctx.fillStyle = "rgba(255,255,255,0.3)";
                ctx.fill();

                // ç”» Emoji
                ctx.font = `${r * 1.2}px serif`; // Emoji å­—ä½“å¤§å°
                // ä¿®æ­£ Emoji å‚ç›´å±…ä¸­åç§»
                ctx.fillText(body.emoji, 0, r * 0.1); 

                ctx.rotate(-body.angle);
                ctx.translate(-body.position.x, -body.position.y);
            }

            // 5. ç»˜åˆ¶ç²’å­ç‰¹æ•ˆ
            for(let i=particles.length-1; i>=0; i--) {
                let p = particles[i];
                p.x += p.vx;
                p.y += p.vy;
                p.life -= 0.02;
                p.vy += 0.5; // é‡åŠ›

                if(p.life <= 0) {
                    particles.splice(i, 1);
                    continue;
                }

                ctx.globalAlpha = p.life;
                ctx.fillStyle = p.color;
                ctx.beginPath();
                ctx.arc(p.x, p.y, p.size, 0, Math.PI*2);
                ctx.fill();
                ctx.globalAlpha = 1.0;
            }

            // 6. æ£€æŸ¥æ¸¸æˆç»“æŸ
            if(!isGameOver) checkGameOver();

            requestAnimationFrame(renderLoop);
        }

        // --- å…¨å±€æ§åˆ¶ ---
        function resetGame() {
            World.clear(engine.world);
            Engine.clear(engine);
            
            // é‡å»ºå¢™å£
            const ground = Bodies.rectangle(width/2, height + WALL_THICKNESS/2, width, WALL_THICKNESS, { isStatic: true });
            const leftWall = Bodies.rectangle(0 - WALL_THICKNESS/2, height/2, WALL_THICKNESS, height * 2, { isStatic: true });
            const rightWall = Bodies.rectangle(width + WALL_THICKNESS/2, height/2, WALL_THICKNESS, height * 2, { isStatic: true });
            World.add(engine.world, [ground, leftWall, rightWall]);
            
            score = 0;
            isGameOver = false;
            canDrop = true;
            particles = [];
            updateScore(0);
            document.getElementById('game-over-screen').classList.remove('active');
            prepareNextItem();
        }

        // å£°éŸ³å¼€å…³
        document.getElementById('sound-btn').addEventListener('click', (e) => {
            soundEnabled = !soundEnabled;
            e.target.innerText = soundEnabled ? 'ğŸ”Š' : 'ğŸ”‡';
            e.stopPropagation(); // é˜²æ­¢è§¦å‘æ‰è½
        });

        // çª—å£å¤§å°æ”¹å˜æ—¶é‡ç½® Canvas å°ºå¯¸ (ä¸ºäº†ç®€å•ï¼Œç›´æ¥åˆ·æ–°é¡µé¢æ›´å®‰å…¨ï¼Œä½†è¿™é‡Œåšä¸ªç®€å•é€‚é…)
        window.addEventListener('resize', () => {
             // ç®€å•é‡è½½é¡µé¢ä»¥é€‚é…æ–°å°ºå¯¸
             // location.reload(); 
        });

        // å¯åŠ¨
        window.onload = init;

    </script>
</body>
</html>